/**
  ******************************************************************************
  * 
  * @file      AT_flash.c
  * 
  * @brief     ƒрайвер flash дл€ AT32F413RCT7.
  * 
  * @details   ‘ункции дл€ работы с flash в микроконтроллерах семейства AT32F413.
  *
  * @warning   **¬ј∆Ќќ!**                                                                                              \n 
  * ƒл€ работы драйвера требуетс€: 
  *                       + файл at32f413_flash.c - аппаратный драйвер работы с flash от Artery;
  *                       + файл at32f413_flash.h - header for at32f413_flash.c.
  *
  * **Manual** \n 
  * ¬ драйвере реализованы следующие функции:
  * - Write_Config_to_flash (uint32_t *Data) - запись во FLASH измен€емых параметров модул€ Config Page.               \n 
  *   »змен€емые параметры модул€ могут хранитьс€ в структуре типа uint32_t или типа Config_struct.                    \n 
  *   Ќачальныый адрес дл€ записи/чтени€ измен€емых параметров модул€ во/из FLASH определЄн макросом ADDR_CONFIG_PAGE.
  *
  * - Read_Config_from_flash (Config_struct* Config) - чтение измен€емых параметров модул€ из FLASH                    \n 
  *   в структуру типа Config_struct.
  *   
  * - Read_RO_Constants_from_flash (RO_Constants_struct* RO_Constants) - чтение неизмен€емых параметров модул€         \n 
  *   в структуру типа RO_Constants_struct.
  *
  * - Write_Words_to_flash (uint32_t Address, uint32_t Amount, uint32_t *Words) - запись во FLASH произвольного массива слов.
  *
  * **ќсобенности организации FLASH пам€ти в проекте** \n 
  * ¬ контроллерах серии AT32F403AR размер FLASH может иметь следующие значени€:
  * - 256 Kbyte  (AT32F403ARC),
  * - 512 Kbyte  (AT32F403ARE),
  * - 1024 Kbyte (AT32F403ARG).
  * \n \n 
  *
  * **ќрганизаци€ FLASH пам€ти дл€ AT32F403ARG (1024 Kbyte)** \n 
  *
  * | Block             | Bank               | Name              | Address Range             | Size (bytes) |
  * | ----------------- | :----------------: | :---------------: | :-----------------------: | :----------: |
  * | Main Flash memory | Bank 1 (512 Kbyte) | Page 0            | 0x0800 0000 Ц 0x0800 07FF | 2 KB         |
  * | ^                 | ^                  | Page 1            | 0x0800 0800 Ц 0x0800 0FFF | 2 KB         |
  * | ^                 | ^                  | Page 2            | 0x0800 1000 Ц 0x0800 17FF | 2 KB         |
  * | ^                 | ^                  | ...               | ...                       | ...          |
  * | ^                 | ^                  | Page 255          | 0x0807 F800 Ц 0x0807 FFFF | 2 KB         |
  * | ^                 | Bank 2 (512 Kbyte) | Page 256          | 0x0808 0000 Ц 0x0808 07FF | 2 KB         |
  * | ^                 | ^                  | Page 257          | 0x0808 0800 Ц 0x0808 0FFF | 2 KB         |
  * | ^                 | ^                  | Page 258          | 0x0808 1000 Ц 0x0808 17FF | 2 KB         |
  * | ^                 | ^                  | ...               | ...                       | ...          |
  * | ^                 | ^                  | Page 511          | 0x080F F800 Ц 0x080F FFFF | 2 KB         |
  * | External memory   | 16 MB              | Page 0            | 0x0840 0000 Ц 0x0840 0FFF | 4 KB         |
  * | ^                 | ^                  | Page 1            | 0x0840 1000 Ц 0x0840 1FFF | 4 KB         |
  * | ^                 | ^                  | Page 2            | 0x0840 2000 Ц 0x0840 2FFF | 4 KB         |
  * | ^                 | ^                  | ...               | ...                       | ...          |
  * | ^                 | ^                  | Page 4095         | 0x093F F000 Ц 0x093F FFFF | 4 KB         |
  * | Information Block |                    | Boot loader       | 0x1FFF B000 Ц 0x1FFF EFFF | 16 KB        |
  * | ^                 | ^                  | User option bytes | 0x1FFF F800 Ц 0x1FFF F82F | 48 B         |
  *  \n 
  *
  * **ќрганизаци€ FLASH пам€ти дл€ AT32F403ARE (512 Kbyte)** \n 
  *
  * | Block             | Bank               | Name              | Address Range             | Size (bytes) |
  * | ------------------| :----------------: | :---------------: | :-----------------------: | :----------: |
  * | Main Flash Block  | Bank 1 (512 Kbyte) | Page 0            | 0x0800 0000 Ц 0x0800 07FF | 2 KB         |
  * | ^                 | ^                  | Page 1            | 0x0800 0800 Ц 0x0800 0FFF | 2 KB         |
  * | ^                 | ^                  | Page 2            | 0x0800 1000 - 0x0800 17FF | 2 KB         |
  * | ^                 | ^                  | ...               | ...                       | ...          |
  * | ^                 | ^                  | Page 255          | 0x0807 F800 Ц 0x0807 FFFF | 2 KB         |
  * | External memory   | 16 MB              | Page 0            | 0x0840 0000 Ц 0x0840 0FFF | 4 KB         |
  * | ^                 | ^                  | Page 1            | 0x0840 1000 Ц 0x0840 1FFF | 4 KB         |
  * | ^                 | ^                  | Page 2            | 0x0840 2000 Ц 0x0840 2FFF | 4 KB         |
  * | ^                 | ^                  | ...               | ...                       | ...          |
  * | ^                 | ^                  | Page 4095         | 0x093F F000 Ц 0x093F FFFF | 4 KB         |
  * | Information Block |                    | Boot loader       | 0x1FFF B000 Ц 0x1FFF EFFF | 16 KB        |
  * | ^                 | ^                  | User option bytes | 0x1FFF F800 Ц 0x1FFF F82F | 48 B         |
  * \n 
  *
  * **ќрганизаци€ FLASH пам€ти дл€ AT32F403ARC (256 Kbyte)** \n 
  *
  * | Block             | Bank               | Name              | Address Range             | Size (bytes) |
  * | ------------------| :----------------: | :---------------: | :-----------------------: | :----------: |
  * | Main Flash Block  | Bank 1 (256 Kbyte) | Page 0            | 0x0800 0000 Ц 0x0800 07FF | 2 KB         |
  * | ^                 | ^                  | Page 1            | 0x0800 0800 Ц 0x0800 0FFF | 2 KB         |
  * | ^                 | ^                  | Page 2            | 0x0800 1000 Ц 0x0800 17FF | 2 KB         |
  * | ^                 | ^                  | ...               | ...                       | ...          |
  * | ^                 | ^                  | Page 127          | 0x0803 F800 Ц 0x0803 FFFF | 2 KB         |
  * | External memory   | 16 MB              | Page 0            | 0x0840 0000 Ц 0x0840 0FFF | 4 KB         |
  * | ^                 | ^                  | Page 1            | 0x0840 1000 Ц 0x0840 1FFF | 4 KB         |
  * | ^                 | ^                  | Page 2            | 0x0840 2000 Ц 0x0840 2FFF | 4 KB         |
  * | ^                 | ^                  | ...               | ...                       | ...          |
  * | ^                 | ^                  | Page 4095         | 0x093F F000 Ц 0x093F FFFF | 4 KB         |
  * | Information Block |                    | Boot loader       | 0x1FFF B000 Ц 0x1FFF EFFF | 16 KB        |
  * | ^                 | ^                  | User option bytes | 0x1FFF F800 Ц 0x1FFF F82F | 48 B         |
  * \n 
  *
  * ѕам€ть FLASH используетс€ в соответствии с установленной (кем-то когда-то) картой пам€ти (такой способ организации). \n 
  * ƒл€ хранени€ этой карты пам€ти требуетс€ не менее 128 Kbyte FLASH пам€ти.                                            \n 
  * ѕодразумеваетс€, что используетс€ контроллер серии AT32F403AR c объЄмом FLASH пам€ти 256 Kbyte или более.            \n 
  * ¬ таблице (ниже) представлен способ организации FLASH пам€ти (с учЄтом установленной карты пам€ти)                   \n 
  * дл€ всех контроллеров серии AT32F403AR.                                                                              \n 
  * ¬с€ карта пам€ти во всех контроллерах серии размещаетс€ в Bank 1 Page0...Page63.                                     \n 
  * \n 
  * 
  * ** арта пам€ти дл€ микроконтроллеров серии AT32F403AR**
  * |    Ќазначение     |        Bank        |  Ќомер страницы   |     ƒиапазон адресов      | «анимаемый объем  | „исло страниц |
  * | ----------------- | :----------------: | :---------------: | :-----------------------: | :---------------: | :-----------: |
  * | Bootloader        | Bank 1 (256 Kbyte) | Page 0            | 0x0800 0000 Ц 0x0800 07FF | 28 Kbyte (0x7000) | 14 по 2 KB    |
  * | ^                 | ^                  | ...               | ...                       | ^                 | ^             |
  * | ^                 | ^                  | Page 13           | 0x0800 6800 Ц 0x0800 6FFF | ^                 | ^             |
  * | Main Programm     | ^                  | Page 14           | 0x0800 7000 Ц 0x0800 77FF | 48 Kbyte (0xC000) | 24 по 2 KB    |
  * | ^                 | ^                  | ...               | ...                       | ^                 | ^             |
  * | ^                 | ^                  | Page 37           | 0x0801 2800 Ц 0x0801 2FFF | ^                 | ^             |
  * | Download Buffer   | ^                  | Page 38           | 0x0800 3000 Ц 0x0800 37FF | 48 Kbyte (0xC000) | 24 по 2 KB    |
  * | ^                 | ^                  | ...               | ...                       | ^                 | ^             |
  * | ^                 | ^                  | Page 61           | 0x0801 E800 Ц 0x0801 EFFF | ^                 | ^             |
  * | Config Page       | ^                  | Page 62           | 0x0801 F000 Ц 0x0801 F7FF | 2 Kbyte (0x800)   | 1 по 2 KB     |
  * | RO Constants      | ^                  | Page 63           | 0x0801 F800 Ц 0x0801 FFFF | 2 Kbyte (0x800)   | 1 по 2 KB     |
  * | Unused            | ^                  | Page 64           | 0x0802 0000 Ц 0x0802 07FF | 2 Kbyte (0x800)   | 1 по 2 KB     |
  * | ^                 | ^                  | ...               | ...                       | ...               | ...           |
  * | ^                 | ^                  | Page 127          | 0x0807 F800 Ц 0x0807 FFFF | 2 Kbyte (0x800)   | 1 по 2 KB     |
  * | ^                 | ^                  | ...               | ...                       | ...               | ...           |
  * | ^                 | ...                | ...               | ...                       | ...               | ...           |
  * | Information Block ||                     Boot loader       | 0x1FFF B000 Ц 0x1FFF EFFF | 16 KB             |               |
  * | ^                 ||                     User option bytes | 0x1FFF F800 Ц 0x1FFF F82F | 48 B              |               |
  * 
  * Bootloader      - область расположени€ загрузчика                                                  \n
  * Main Programm   - область расположени€ основной программы                                          \n
  * Download Buffer - область дл€ сохранени€ новой прошивки (используетс€ загрузчиком)                 \n
  * Config Page     - область хранени€ измен€емых параметров модул€                                    \n
  * RO Constants    - область хранени€ неизмен€емых параметров модул€ (записываетс€ при сборке модул€) \n
  * \n 
  *
  * ** арта пам€ти Config Page**
  * | ѕараметр                        |   јдрес    | 0x00  | 0x01  | 0x02 | 0x03 |
  * | ------------------------------- | :--------: | :---: | :---: | :--: | :--: |
  * | јдрес модул€                    | 0x0801F000 | addr  | 0xFF  | 0xFF | 0xFF |
  * | ¬ерси€ загрузчика               | 0x0801F004 | minor | major | 0xFF | 0xFF |
  * | ¬ерси€ программы                | 0x0801F008 | minor | major | 0xFF | 0xFF |
  * | ‘лаг первого запуска            | 0x0801F00C | flag  | 0xFF  | 0xFF | 0xFF |
  * | Ќе используетс€ в модуле Modbus | 0x0801F010 | 0xFF  | 0xFF  | 0xFF | 0xFF |
  * | ѕараметры Modbus порта 0        | 0x0801F014 | baud  |  par  | stop | 0xFF |
  * | ѕараметры Modbus порта 1        | 0x0801F018 | baud  |  par  | stop | 0xFF |
  * | ѕараметры Modbus порта 2        | 0x0801F01C | baud  |  par  | stop | 0xFF |
  * | ѕараметры Modbus порта 3        | 0x0801F020 | baud  |  par  | stop | 0xFF |
  * —траница Config Page содержит параметры модул€, записанные в виде 32-битных слов.
  * \n \n 
  *
  * ** арта пам€ти RO Constants**
  * | ѕараметр           |   јдрес    | 0x00  | 0x01  | 0x02 | 0x03 |
  * | ------------------ | :--------: | :---: | :---: | :--: | :--: |
  * | “ип модул€         | 0x0801F800 | class | 0xFF  | 0xFF | 0xFF |
  * | јппаратна€ ревизи€ | 0x0801F804 | minor | major | 0xFF | 0xFF |
  * | —ерийный номер lw  | 0x0801F808 | 0xFF  | 0xFF  | 0xFF | 0xFF |
  * | —ерийный номер hw  | 0x0801F80C | 0xFF  | 0xFF  | 0xFF | 0xFF |
  *
  * —траница RO Constants содержит параметры модул€, записанные в виде 32-битных слов.
  * \n \n 
  *
  * 
  * @copyright Copyright (C) 2022 Awada Systems. ¬се права защищены.
  *
  * @author    Larionov A.S. (larion.alex@mail.ru)
  * 
  ******************************************************************************
**/

//---Includes-------------------------------------------------------------------//
#include "AT_flash.h"
#include "at32f413_flash.h"
//------------------------------------------------------------------------------//

//---Private macros-------------------------------------------------------------//
#define FLASH_SIZE            (*(uint32_t*)0x1FFFF7E0)             /*!< Flash size, in terms of KByte.               */
#define PAGE0_ADDR            0x08000000U                          /*!< јдрес начала первой страницы FLASH.          */
#define END_ADDR_OF_LAST_PAGE (PAGE0_ADDR + FLASH_SIZE * 1024 - 1) /*!< јдрес последнего байта в последней странице. */

//---–азмеры требуемой FLASH пам€ти в Kbyte дл€ размещени€ соответствующих областей---//
#define MEMSIZE_BOOTLOADER       28 /*!< –азмер требуемой FLASH пам€ти в Kbyte.       */
#define MEMSIZE_MAIN_PROGRAM     48 /*!< –азмер требуемой FLASH пам€ти в Kbyte.       */
#define MEMSIZE_DOWNLOAD_BUFFER  48 /*!< –азмер требуемой FLASH пам€ти в Kbyte.       */
#define MEMSIZE_CONFIG_PAGE      2  /*!< –азмер требуемой FLASH пам€ти в Kbyte.       */
#define MEMSIZE_RO_CONSTANS      2  /*!< –азмер требуемой FLASH пам€ти в Kbyte.       */
//------------------------------------------------------------------------------------//

//---Ќачальные адреса соответствующих областей во FLASH---//
#define ADDR_BOOTLOADER       PAGE0_ADDR                                              /*!< Ќачальный адрес секции BootLoader.                   */
#define ADDR_MAIN_PROGRAM     (ADDR_BOOTLOADER      + MEMSIZE_BOOTLOADER      * 1024) /*!< 0x08007000U // Ќачальный адрес секции MainProgram.   */
#define ADDR_DOWNLOAD_BUFFER  (ADDR_MAIN_PROGRAM    + MEMSIZE_MAIN_PROGRAM    * 1024) /*!< 0x08013000U // Ќачальный адрес секции DowloadBuffer. */
#define ADDR_CONFIG_PAGE      (ADDR_DOWNLOAD_BUFFER + MEMSIZE_DOWNLOAD_BUFFER * 1024) /*!< 0x0801F000U // Ќачальный адрес секции ConfigPage.    */
#define ADDR_RO_CONSTANS      (ADDR_CONFIG_PAGE     + MEMSIZE_CONFIG_PAGE     * 1024) /*!< 0x0801F800U // Ќачальный адрес секции RO_Constans.   */
//--------------------------------------------------------//

#define DEF_FLASH_ADDR (END_ADDR_OF_LAST_PAGE - PAGE_SIZE_2KB + 1 ) /*!< јдрес дл€ записи по умолчанию - адрес начала последней страницы flash (0x803F800). */

//------------------------------------------------------------------------------//

//---Exported variables---------------------------------------------------------//
//------------------------------------------------------------------------------//

//---Private types--------------------------------------------------------------//
//------------------------------------------------------------------------------//

//---Private variables----------------------------------------------------------//
//------------------------------------------------------------------------------//

//---Private constants----------------------------------------------------------//
//------------------------------------------------------------------------------//

//---Function prototypes--------------------------------------------------------//
//------------------------------------------------------------------------------//

//---Exported functions---------------------------------------------------------//
/**
  * @brief   «апись Config во FLASH.
  * @param   Data - указатель типа uint32_t* на структуру с данными Config.
  * @return  flash status.
  */
flash_status Write_Config_to_flash (uint32_t* Data)
{
flash_status_type state;

flash_unlock(); // Unlock the main FMC operation.
state = flash_sector_erase(ADDR_CONFIG_PAGE);
if (state != FLASH_OPERATE_DONE)
  return FLASH_ERROR;
else
  {
  for (uint8_t i = 0; i < NUM_OF_CONFIG_WORDS; i++)
    {
    state = flash_word_program(ADDR_CONFIG_PAGE + 4*i, *(Data+i)); // Program a word at the corresponding address.
    if (state != FLASH_OPERATE_DONE)
      {
      break;
      }
    }
  }
flash_lock(); // Lock the main FMC operation.

if (state != FLASH_OPERATE_DONE)
  return FLASH_ERROR;
else
  return FLASH_OK;
}
//------------------------------------------------------------------------------//


/**
  * @brief   „тение Config из FLASH.
  * @param   Config - указатель типа Config_struct* на структуру с данными Config.
  * @return  None.
  */
void Read_Config_from_flash (Config_struct* Config)
{
*Config = *((Config_struct*)ADDR_CONFIG_PAGE);
}
//------------------------------------------------------------------------------//


/**
  * @brief   „тение RO_Constants из FLASH.
  * @param   RO_Constants - указатель типа RO_Constants_struct* на структуру с данными RO_Constants.
  * @return  None.
  */
void Read_RO_Constants_from_flash (RO_Constants_struct* RO_Constants)
{
*RO_Constants = *((RO_Constants_struct*)ADDR_RO_CONSTANS);
}
//------------------------------------------------------------------------------//


/**
  * @brief   «апись массива данных во FLASH.
  * @details ‘ункци€ записи массива слов во FLASH.
  * @param   Address - адрес начальной €чейки пам€ти.
  * @param   Amount  - количество записываемых слов.
  * @param   Words   - указатель типа uint32_t* на массив с данными. ƒанные должны быть выровнены по 4 байта.
  * @return  flash status.
  */
flash_status Write_Words_to_flash (uint32_t Address, uint32_t Amount, uint32_t *Words)
{
flash_status_type state;

if ( (Address < PAGE0_ADDR) || (Address > END_ADDR_OF_LAST_PAGE) )
  return FLASH_WROG_ADDRES;

flash_unlock(); // Unlock the main FMC operation.
state = flash_sector_erase(Address);
if (state != FLASH_OPERATE_DONE)
  return FLASH_ERROR;
else
  {
  for (uint32_t i = 0; i < Amount; i++)
    {
    state = flash_word_program(Address + 4*i, (uint32_t)*(Words + i)); // Program a halfword at the corresponding address.
    if (state != FLASH_OPERATE_DONE)
      {
      break;
      }
    }
  }
flash_lock(); // Lock the main FMC operation.

if (state != FLASH_OPERATE_DONE)
  return FLASH_ERROR;
else
  return FLASH_OK;
}
//------------------------------------------------------------------------------//
//------------------------------------------------------------------------------//


//---Private functions----------------------------------------------------------//
//------------------------------------------------------------------------------//


//***************************************END OF FILE**************************************//
